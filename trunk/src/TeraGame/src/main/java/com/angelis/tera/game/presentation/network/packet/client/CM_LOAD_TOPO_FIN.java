package com.angelis.tera.game.presentation.network.packet.client;

import java.nio.ByteBuffer;
import java.util.concurrent.TimeUnit;

import com.angelis.tera.game.presentation.network.SystemMessages;
import com.angelis.tera.game.presentation.network.connection.TeraGameConnection;
import com.angelis.tera.game.presentation.network.packet.TeraClientPacket;
import com.angelis.tera.game.presentation.network.packet.server.SM_ACHIEVEMENT_PROGRESS_UPDATE;
import com.angelis.tera.game.presentation.network.packet.server.SM_CREATURE_UNK;
import com.angelis.tera.game.presentation.network.packet.server.SM_F2P_PREMIUM_USER_PERMISSION;
import com.angelis.tera.game.presentation.network.packet.server.SM_GATHERCRAFT_POINT;
import com.angelis.tera.game.presentation.network.packet.server.SM_OPCODE_LESS_PACKET;
import com.angelis.tera.game.presentation.network.packet.server.SM_OWN_PLAYER_SPAWN;
import com.angelis.tera.game.presentation.network.packet.server.SM_PEGASUS_START;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_CHANNEL_INFO;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_FRIEND_LIST;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_GATHER_STATS;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_STATS_UPDATE;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_UNK;
import com.angelis.tera.game.presentation.network.packet.server.SM_USER_SETTINGS_LOAD;
import com.angelis.tera.game.process.model.channel.Channel;
import com.angelis.tera.game.process.model.creature.AbstractCreature;
import com.angelis.tera.game.process.model.player.Player;
import com.angelis.tera.game.process.model.visible.VisibleTeraObject;
import com.angelis.tera.game.process.model.visible.enums.VisibleTypeEnum;
import com.angelis.tera.game.process.services.ThreadPoolService;
import com.angelis.tera.game.process.services.VisibleService;
import com.angelis.tera.game.process.tasks.pegasus.EndPegasusFlyTask;

public class CM_LOAD_TOPO_FIN extends TeraClientPacket {

    public CM_LOAD_TOPO_FIN(final ByteBuffer byteBuffer, final TeraGameConnection connection) {
        super(byteBuffer, connection);
    }

    @Override
    protected void readImpl() {
        // Empty packet
    }

    @Override
    protected void runImpl() {
        final TeraGameConnection connection = this.getConnection();
        final Player player = connection.getActivePlayer();

        connection.sendPacket(new SM_PLAYER_FRIEND_LIST(player));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("E96800000000"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("9FCD00000000"));

        // CONTROLLERS
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("A8C80800870F089756120432234350528509089756522053003100430068006100740043006F006E00740072006F006C006C0065007200A201D50878DABD584D881C45147E6F7F86A550690691262CA16C37EBBA89C96632BB594A303B3B335997CCCC3633B35191B0F83392838912CD218188DEFC41F42478930111CD4DF1908328089E72F0E26183871CCD2112F0103087F5D5DB99E9EE9DEAEEEA3191651ABAFA7BBFF5D57BAF76EAEF4EFEE3877DF812E10E4EFD3C7675EAB3F11B9337C77F1CFB6EE29135B805E7E977015E8637E09349807F567F9B7CBA9B936A7F199E8312B4E9EF45F0A10A5BD0800D68429D566BD0CDED57D3C3109FDE9BFC1E0358834D5827F94A1240EBD08069B56F18D0A66789BC88F95C26E59BB04A9F3D25873F3F4F2BEBD0E2B726810A6A210DB445BF2AE9ADD2DA697AC6186ED2FB3ABB3DAFE6E23F6F917F3A804ACF815935634A63938D9538DA2D386A0B2CD8028FD9028BB6C0455BE0922DF0B82D70396EB72B9CEA1A811B44AC6EEE909A4FE2EC2EC5DB042FF33E1B75960952E753D0E0DD5E508787412D7A36786D831914D56B744353A2CE9EEE85A7F0C9C2E73576A7CA42B538026BD32749573737A7664D87428752639329506DA8D98B3C051A4E7E0A34281D61A89120FD1A11061655C11C73BB9798326771833720108BA922DAEBC6805733CA3327BDCDBAB4857AD2DEB439692FD04A4C407D509DFDAB727D75D563265A681DC6F2DD22D932799350BE3739266D22660F0240958F553B9ECF01344AD1FC75F4D1D48D1E5AA33EF4265C84B7A013EE45A98DE6419C6A6BB2E6BF413F676CAE2BF02A9CA5C6FA0E282AB76901FD2FA9FF6AC21F33A6BE4C893F07AFB0B7214F8D5CAC73FCBB6BFAD49C223796D5521CB0CCC57AD7054DBDBDA209362A7C884BCCFE8C36A2A24BAA18277A9205FA2D62AFA0713C18764E1FAE7A4F51375751ABA3391A55636DBBC6B4DC75F83FD80ED4E4CFF8E3464AB7E012BC4D14F993C81239A3993A5A7ED39F30A9CF35E135B29FA6367C0A5B5CE89BA051F98FD09F34E975EA54542E90CBFAD9A10042161ED490E83D255226686707DD1D943BE8CD8AC402E7A0FB39E30E88C481DA5971EFA15CF19E148963B5F32DBA5FB3BE7961887DB5C782126F9CF30BBA97E5FBE83D211246711DCA15096685D13C69E8BBDAF88C4898A135EA3A92C6A3C27A94EE3B5110D6D39253D156C89983227578D4EA7F42F9297A459181940313A95211C75EEF51C3B897417977DE43F70F9457D15B10962DC3C9BB3FA0DE51A343719D632065CC5474BC74EE30B13F44F319088F213AA9D7505E43EF711133CC049023C2AA1939DBE86EA3DC466F458CD894B4CDEF519EF59E1523F50D2DBF213F404F89CCED63207B4ADC872EE2DC46F751F99277585835D981F11362C45EDB37681D79D075EE47E4216D3D47164586CE1450F78048B821694FEFA2FC02A93E59DE9402561E11963726E72F74A7E58CD98669144DB161BA3FF57B86F16C0DDFA2020BCF88116E533A6F1DD9A1BA907AA7EA077F4858DCACB4DE9B284F981B50F48235C01A8FC4F03D6B8037A668F81F35CEEF4CA15FD14EA09055E0585681625681C5AC024B59058E6715580E04E6E05F77919CF3F00101C002D22952630897565246530031004D0069006E0069006D006100700043006F006E00740072006F006C006C00650072005F00530031004D0069006E0069006D00610070004F007000740069006F006E00A2010F78DAE3389F2AC4C3880400155A0167F00101C0021152BC14089756521E53003100550049005F004700460078004D0061006E006100670065007200A2018E1478DA8D59DD6F5C47159F54504557A88ADC2A8AA2509928B70A5540B11D594D8582EFAC13AF1B6FBCF17A63091EC27A776D2F59AFB7FB11D77C481508A90FA84FA4D00A44113CA0A6CF20A416FA808891D27F80171042E2914A3C0042429CF39BB9773E77DBACD6CEBDF39B99F3F93B67C6C999245913EB6245AC8A5BE2D489CF0AFA97F28FE45CF25445B4C5903E0DB14BFF73462F24A733B12D7AE2400CC43E21BAA22346E2489C1284FA892CD6D8A6993DFAEE609C46EBF54FFF2E1D9C3B94C973C9991A8D74E9DBA431FEFF40DCC74F67AF4BC9B336AE24F668BF017DF90968E1A24BF4AE4DE33C1A417B7AD4C43D92AD4B9F326933123709A5F5F81AEB51962E6A8B7EF7448BB0878C7AF8CEC697499F474BC9B3C9A91AEDC6166129C7AC2FEFB5C6ABFC41F2385B8A67EFC32A631E5FBEF4924C9FFECA4399CC2633ABF4F63EC6465847CB710C3932B6D8CB348BBD32125F27C498303D581F96FDDEB5F478F1DBC029BDFB5AE732B043F662602BDF3E9E7E064DF2B1650F10137BD0C4B33DD9A98AD53812E2EBCC66BCEB16506D584BC9E5A1A1CBB9477399B2BDB2C674D426B4688528231F79C0A0D6687CD71D47CCF3DC0E62BAAFFC77ACA3F972727E85A4E52868093BC626EEF7C564D6CC5881EDC6B4EA443C59A6496FF7E93386146CC7C3493A933FFA9092BDC6E35D2B0E80389F3CA3FCD144FE54E1BB51A0F3755ABF098FF6F2D132EBFC25995C4CCE9AC85F83C60348D6F36DF77C72EE8EC629BE1888657AE6D80CEC4CAB96A1276B19C9990F1F3FBE96EEEC9CCE1879BB88F84D5A6D48D27096ECD01C42EEEC3C62498F11F366CD0A74C9E5F0E534B855683E26266BE81873B06793CFA8285937D99C5B86F61B92778688807D4271AE75E8772FEA03E5418E3D49BF5F516BCD6A7E21BFAFC2F6ED2213D54A15C313462AE26C95B52331EFCA8BBD38CA5A34A769CBE3E8DF8F6098BF87DAFAFF5B61B996B26431B9185BEF3AC93FF22475F6782179FE93CE9B0F18C478E70EB46F857E717C68A3B84E8C229C34801707BA9E4944B189F31F48CE028958E568853E277CDE5015A8AF63D5DFA366C54215D130CEF9C36283B89727E0C98A8C5F212CD70BC38219E4E4A83AD29564E4CEA438303C37617592F99655BD27A0C82E2358A40B69FB815D4C767642BBCD27176271E0FB0373BEC39E784DE656CAB5B63379534BE2E40E31C47D8F77F6E02BF6A4938914CDD3EC5FA76F863CD8B7AAEE317630CCA7BA83BADB1595B52C24FB32F6EE886DBD4BBE87C559064F0C6EAAC2322CD97523EBC5E4528850513ED22CEC549362F58FC09D394F30736E138BF5E3F94A5E5ED1FA4472E37472B28C7DFBFCFEC3C76BD7D2858554323B7246F7ED3958F1181D5349D79332EDD88227875C07BCF8D92DBCD6CEF9E71F1BAF65E93FC5A255BFB80E326F3650E97C0BC5301BB4DEAEE634DB0FB4FEF96F7D5EA60FDFB926797D539FD9C7F7430F908F6E03D3A4CA53F0B1B0BC48AB8C8A6C331D0DED547FF0D7A5F4AEFC4296F3CB40ECEA0ED0E7ED4D3DCA9EB562E5AD37FF9CA5DF7CE6C54CF5127E2448271260DB332CD5BFB3E44AF29CB1CB1A3227C7D5C25979CC505593E206219A9A6B2CAB17B8BF2CB17FDD2C3D109C85B1530277161D6DDB82ADBC6E20D6A544FA33E2FD35C8D32A346106DC062B0C83BD8D6FA7F5B487D09451AAE79BE7750EFF93D7405A675D9F4ABA60DC8A412D2CDC95E95B6FFE11D6B6EDB1AEBB3213770E77FD322BF4B1674960EE618701FD361657B95285DF3A2ED7627C56D7EA300F2AB0BA62A3280751ECD5E095BC0352FA99089FCD54176863AAA885AD900175C6F675FFA77AD2799787A9DB71BD18D48362EFDF4875EA5051CF3AEBEEC9EBB27DE90EC0C14DB244A42308B4E1DC7B258674F8A16438CA5B4D8DB4E019DBDEC3A0FE87A7AD2AE6AADC39B4347F5B7785AAA3A8E9D35C7E9EED29CB0BBFBBF0D11B5A6295CB0E9E22D6B5C214C634FC4016C9775926EBB66327015435C3AA9DD066846096D98026F726AC61CE1D5548B387287AF0EB2C7DF4F27B4BA1D7794F15F3459CDB2B527EE47956825E23445D17913C985C1BA9BEECEA79CDC8BC61717A69E66784F7DEFDA94C6B3FFE15AAA0E98FBCD390C907AA0D35C477D15BDA794D5576C3EE3BED318A109BE31AC83996B3A123D28F541F5D823CC1BD00EE0F145F6DA21F6A9BCE88F7FF88F9EB0DC9FDDD721131DCF38C0B1BFA5DC9ABA94CE57F0F6113B7C284AC248052A785E074C872FE42D2E9F0186C639F0E95A4FA86E75D5EE947E0EF9B3A8E148FF4EC7B20A07E8FB3F4CD22DA0E20FBC842A8C867B92B883755D374F5AC3FF821F83CE31B821846F15BD3EE76FBC8F14C5970ACF3B9A7F3758C6E3BDED75D911CC9668EEA5F73DE0FA4B3BDBA9C2C7ED2795324261DED9AA53ACBAE7F0B624729553989DAC91D94F19713514E2F909F4436E1F103C45623AF9D79A5A1555D6DA6B009D54EC38DEDFCBECC8C934EF1B56C7F383E20F67467D4A04B1F9698388B3CE7EB745D33CA919872DBEAF472B69D37D04D7A8CF776A6EC8E53F8B4598A07F9667637B859BA097F711DC92DE73384F113F778CD22B71C2F91E5EDF36B231FFF2D8F7F20F92EA38EFBA4807749867131D231FA2D7C752E4BFF357316B963E62A5D94D5CB9A93AC1B54AB4AC6E7546199E0B688A430F8FC8C64AA74554BD1276BAABBC05BBACFDE41FFD1706B8AC5DB6655C33735DD1DB4DD9AEBA02BF8D9466753A083FB8E929870937C412AE6A6335D29EF0AEC5B2DDC08ABF77645F46E07AC6EC08C587E0C3AC2363AA389777264E53BFA9478603A06C321D23F6F98BB10A03EC854AFEEDD1D18D404F9298A33787D88DBA43671F740CF05EEA2A47CF81C6A700D7CD8897287EA6554CE0FB09F7D83E776D3EAAF09461E872B3C540927C91164EB886FD8CC56363787FBB4DB5D11CFF4F98247D6F6520BDD2FD0F6EDF2E502FDB717BE9B7D1C7A0EB5AFFEE07D92E4EFD9C749B250AC5DAF6F49C51F392EE7A30ACD5732CCBE21D3ABAFBF9E4DC6A9DDE708F7F49F7E3E05A72C7092703F7BBF9F31DF4CB84740953AD0674F8ED029B7E24E677E84F13DF891BDD476EE4FD44DF10D4415F7174793CFA2F87B58DEF332A7AC14B70AE1797980DD3B1421FB147D63EC1D70284EF30D9CF583BA644E1AC8E30C2BF6F4FDB4651F605E5D52B962300DFB064158993AE1EED7FE7B89B96F3333BF2F55950B67E6B5CD9B65D576737775E09D1F05BA8FAAB843DE9CF8173C27064AE0CA216A55775A0C106755F58D80EAAA5B4E6598953333C9C93AEDBA4ABBCF3C3947917D59E4EF6E8B9782773571D3BC7B8AF9799324A5B94FA8E7758AE71AE938F3C41CE6F0734656B1E764547F329A97CFE1E765CCC9D7DCA219E67995D025677C5DEF61F0C59EA792E406CDAE39880AED760552CE15CF8BDEF355EF597ACFABCE337FCCFAB769DC7A7E922D5512339FBA6A59AE4415DFB7668534F7DFAD473D518F78A21459AF12BCCB582EEF5D99BEFEBB124588FFAECA5E0A701BC13B1959EF7AE4DD56C4065B1199AB11BBAC103294652B3237D47793E22BB45F6C6E3562AB6A04B71A91CFF8E3CC89FF033B74252AF00101C002B4415250089756523A53003100470061006D0065004F007000740069006F006E005F005300310049006E007400650072006600610063006500470072006F0075007000A2010808CF6D1D0000803FF00100C00208"));
        connection.sendPacket(new SM_USER_SETTINGS_LOAD(player));

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("B1EC0000000000000000"));
        connection.sendPacket(SystemMessages.CONNECT_ON_TERA_EUROPE_FOR_LAST_NEWS());

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("7D990000000000000000"));
        connection.sendPacket(new SM_OWN_PLAYER_SPAWN(player));

        player.getKnownList().forceUpdate();

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("25AE000000007B690E0000800001"));

        if (player.getCurrentStats().getStamina() == 120) {
            connection.sendPacket(SystemMessages.YOU_HAVE_ABUNDANT_STAMINA());
        }

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("38B87B690E00008000017CC4000001FFFFFF7F"));

        connection.sendPacket(new SM_PLAYER_STATS_UPDATE(player));
        connection.sendPacket(new SM_PLAYER_GATHER_STATS(player.getGatherStats()));
        connection.sendPacket(new SM_F2P_PREMIUM_USER_PERMISSION());

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("DBD2000000000000000000000000"));

        // This packet contains lot of P and Q
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("31C0100020007B690E00008000013C03000010000000DC0000000000000020003000070000002CE6315300000000300040000A000000E5C9C65300000000400050001300000010931A5100000000500060001A00000077304C530000000060007000290000001A5619510000000070008000500000004D51195100000000800090007900000003C34E53000000009000A0007D000000DBD1D45300000000A000B000810000000D911A5100000000B000C00089000000CF4F195100000000C000D00090000000D3931A5100000000D000E000AF000000CB55195100000000E000F000B80000008F911A5100000000F0000001CC000000E5C9C653000000000001100173010000ABB935530000000010010000E20100008D4F195100000000"));

        connection.sendPacket(new SM_ACHIEVEMENT_PROGRESS_UPDATE(player));

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("395B010009000009000000B2010000E9FF672B00000000FFFFFF7F0000000000000000"));

        connection.sendPacket(new SM_PLAYER_STATS_UPDATE(player));
        connection.sendPacket(new SM_PLAYER_GATHER_STATS(player.getGatherStats()));
        connection.sendPacket(new SM_F2P_PREMIUM_USER_PERMISSION());

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("FEBE7B690E00008000010000000000"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("456D000000007B690E0000800001"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("A361"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("19ED00000000"));

        final Channel channel = player.getChannel();
        // TODO channel should not be null
        if (channel != null) {
            connection.sendPacket(new SM_PLAYER_CHANNEL_INFO(channel, player.getWorldPosition().getMapId()));
        }
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("B4F5FFFFFFFF7B690E0000800001"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("B4F5FFFFFFFF7B690E0000800001"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("88F5000000004F430E0000800002"));

        switch (connection.getAccount().getAccountType()) {
            case NORMAL:
            // TODO
            break;

            case VETERAN:
                connection.sendPacket(SystemMessages.ACCOUNT_BENEFIT("433"));
            break;

            case PREMIUM:
                connection.sendPacket(SystemMessages.ACCOUNT_BENEFIT("434"));
            break;
        }
        
        connection.sendPacket(new SM_PLAYER_UNK(player));
        connection.sendPacket(new SM_GATHERCRAFT_POINT(player));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("BEAC010000000000000000"));

        if (player.getActivePegasus() != null) {
            VisibleService.getInstance().sendPacketForVisible(player, new SM_PEGASUS_START(player, 1));
            ThreadPoolService.getInstance().scheduleRepeatableTask(new EndPegasusFlyTask(player), 0, 3000, TimeUnit.MILLISECONDS);
        }

        for (final VisibleTeraObject visibleTeraObject : player.getKnownList().getVisible(VisibleTypeEnum.CREATURE)) {
            connection.sendPacket(new SM_CREATURE_UNK((AbstractCreature) visibleTeraObject));
        }

        // TODO
        connection.sendPacket(SystemMessages.AN_ITEM_IS_AWAITING_IN_CLAME());
        
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("4AF100"));
    }
}
