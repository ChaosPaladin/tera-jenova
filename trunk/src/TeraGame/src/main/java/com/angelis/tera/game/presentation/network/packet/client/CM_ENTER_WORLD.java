package com.angelis.tera.game.presentation.network.packet.client;

import java.nio.ByteBuffer;

import com.angelis.tera.game.presentation.network.SystemMessages;
import com.angelis.tera.game.presentation.network.connection.TeraGameConnection;
import com.angelis.tera.game.presentation.network.packet.TeraClientPacket;
import com.angelis.tera.game.presentation.network.packet.server.SM_AVAILABLE_SOCIAL_LIST;
import com.angelis.tera.game.presentation.network.packet.server.SM_ENTER_WORLD;
import com.angelis.tera.game.presentation.network.packet.server.SM_F2P_PREMIUM_USER_PERMISSION;
import com.angelis.tera.game.presentation.network.packet.server.SM_FESTIVAL_LIST;
import com.angelis.tera.game.presentation.network.packet.server.SM_INVENTORY;
import com.angelis.tera.game.presentation.network.packet.server.SM_LOAD_HINT;
import com.angelis.tera.game.presentation.network.packet.server.SM_LOAD_TOPO;
import com.angelis.tera.game.presentation.network.packet.server.SM_LOGIN;
import com.angelis.tera.game.presentation.network.packet.server.SM_MASSTIGE_STATUS;
import com.angelis.tera.game.presentation.network.packet.server.SM_MOVE_DISTANCE_DELTA;
import com.angelis.tera.game.presentation.network.packet.server.SM_NPC_GUILD_LIST;
import com.angelis.tera.game.presentation.network.packet.server.SM_OPCODE_LESS_PACKET;
import com.angelis.tera.game.presentation.network.packet.server.SM_PET_INCUBATOR_INFO_CHANGE;
import com.angelis.tera.game.presentation.network.packet.server.SM_PET_INFO_CLEAR;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_APPEARANCE_CHANGE;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_DESCRIPTION;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_EQUIP_ITEM_CHANGER;
import com.angelis.tera.game.presentation.network.packet.server.SM_PLAYER_SKILL_LIST;
import com.angelis.tera.game.presentation.network.packet.server.SM_VIRTUAL_LATENCY;
import com.angelis.tera.game.process.model.player.Player;
import com.angelis.tera.game.process.services.CraftService;
import com.angelis.tera.game.process.services.PlayerService;
import com.angelis.tera.game.process.services.QuestService;

public class CM_ENTER_WORLD extends TeraClientPacket {

    private int playerId;
    private boolean withProlog;

    public CM_ENTER_WORLD(final ByteBuffer byteBuffer, final TeraGameConnection connection) {
        super(byteBuffer, connection);
    }

    @Override
    protected void readImpl() {
        this.playerId = readD();
        this.withProlog = readC() == 1;
    }

    @Override
    protected void runImpl() {
        final TeraGameConnection connection = this.getConnection();
        final Player player = connection.getAccount().getPlayerById(this.playerId);

        if (player == null) {
            return;
        }

        PlayerService.getInstance().registerPlayer(connection, player);

        connection.sendPacket(new SM_ENTER_WORLD());

        try {
            Thread.sleep(3000);
        }
        catch (final InterruptedException e) {
            e.printStackTrace();
        }

        // connection.sendPacket(new SM_CURRENT_ELECTION_STATE());

        connection.sendPacket(new SM_LOGIN(player));
        connection.sendPacket(new SM_INVENTORY(player, false));
        connection.sendPacket(new SM_PLAYER_SKILL_LIST(player));

        connection.sendPacket(new SM_AVAILABLE_SOCIAL_LIST());

        QuestService.getInstance().onPlayerEnterWorld(player);

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("2AB06E050000EEF3760100"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("2AB01A0500004EF4760100"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("2AB01F050000851EB50300"));

        CraftService.getInstance().onPlayerEnterWorld(player);

        connection.sendPacket(new SM_NPC_GUILD_LIST());

        connection.sendPacket(new SM_PET_INCUBATOR_INFO_CHANGE());
        connection.sendPacket(new SM_PET_INFO_CLEAR());
        connection.sendPacket(new SM_VIRTUAL_LATENCY());
        connection.sendPacket(new SM_MOVE_DISTANCE_DELTA());
        connection.sendPacket(new SM_PLAYER_DESCRIPTION(player));
        connection.sendPacket(new SM_F2P_PREMIUM_USER_PERMISSION());
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("02C10000000000000000"));

        // connection.sendPacket(SystemMessages.YOU_CAN_JOIN_GUILD_VIA_SOCIAL_LINK());
        connection.sendPacket(SystemMessages.UNKONW());

        connection.sendPacket(new SM_MASSTIGE_STATUS());

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("36830000000000000000000000000000000000000000000000000000000000000000000080656E7380496E668074696F6F20697408000000"));

        connection.sendPacket(new SM_PLAYER_APPEARANCE_CHANGE(player));
        connection.sendPacket(new SM_PLAYER_EQUIP_ITEM_CHANGER());
        connection.sendPacket(new SM_FESTIVAL_LIST());

        connection.sendPacket(new SM_LOAD_TOPO(player.getWorldPosition()));
        connection.sendPacket(new SM_LOAD_HINT());

        connection.sendPacket(new SM_OPCODE_LESS_PACKET("395B010009000009000000B2010000F1FF672B00000000FFFFFF7F0000000000000000"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("63C23ECD00000E00985400000000"));
        
        // TODO HERE IF THE WELCOME MESSAGE IS SET (this is new extension welcome message)
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("23AB0C00340053000000540045005200410020003A002000460061007400650020006F00660020004100720075006E0000007B0041007D004C00610020006D006900730065002000E00020006A006F00750072002000320039002E00300033002C0020007000750062006C006900E900650020006C00650020006A00650075006400690020003100310020006400E900630065006D00620072006500200032003000310034002C00200063006F006D007000720065006E00640020006C00650020006E006900760065006100750020006D006100780069006D0061006C0020006100750067006D0065006E007400E9002000E0002000360035002C0020006400650020006E006F007500760065006C006C0065007300200063006F006D007000E900740065006E006300650073002C002000710075006100740072006500200064006F006E006A006F006E0073002000650074002000630069006E00710020007200E900670069006F006E00730020006100760065006300200071007500EA007400650073002E007B002F0041007D003C00620072003E007B0031007D0051007500610074007200650020006E006F00750076006500610075007800200064006F006E006A006F006E0073007B002F0031007D003C00620072003E007B0041007D00410072006D00750072006500720069006500200053006100620065007800200028006E00690076006500610075002000360031002B0029007B002F0041007D007B0041007D00430061007400610063006F006D0062006500730020006400650020004D006100630065006C006C0061007200690075007300200028006E00690076006500610075002000360034002B0029007B002F0041007D007B0041007D0047006F00720067006500200076006F007200610063006500200028006E00690076006500610075002000360035002B0029007B002F0041007D007B0041007D0041007300630065006E00730069006F006E002000620061007400680079007300730061006C006500200028006E00690076006500610075002000360035002B0029007B002F0041007D003C00620072003E007B0032007D004C00650020004E006F00720064002000640027004100720075006E007B002F0032007D003C00620072003E007B0041007D007B0066006F006E007400200063006F006C006F0072003D002200230046004600300030003000300022007D00340020006E006F007500760065006C006C006500730020007200E900670069006F006E0073007B002F0066006F006E0074007D0020006500740020007B0066006F006E007400200063006F006C006F0072003D002200230046004600300030003000300022007D00310020006E006F007500760065006C006C0065002000760069006C006C0065007B002F0066006F006E0074007D0020003A007B002F0041007D007B0041007D0050006C00610069006E0065002000620061007200620061007200650020002800E000200070006100720074006900720020006400750020006E006900760065006100750020003600300029007B002F0041007D007B0041007D00560061006C006C00E900650020007000720069006E00740061006E006900E8007200650020002800E000200070006100720074006900720020006400750020006E006900760065006100750020003600310029007B002F0041007D007B0041007D004500780020005000720069006D00610020002800E000200070006100720074006900720020006400750020006E006900760065006100750020003600330029007B002F0041007D007B0041007D00410072007800200055006D0062007200610020002800E000200070006100720074006900720020006400750020006E006900760065006100750020003600340029007B002F0041007D007B0041007D00480061007500740065006700610072006400650020002800560069006C006C00650029007B002F0041007D003C00620072003E007B0033007D004E006F007500760065006C006C0065007300200063006F006D007000E900740065006E00630065007300200064006500200063006C0061007300730065007B002F0033007D003C00620072003E007B0041007D007B0066006F006E007400200063006F006C006F0072003D002200230046004600300030003000300022007D004A0075007300710075002700E0002000330020006E006F007500760065006C006C0065007300200063006F006D007000E900740065006E006300650073007B002F0066006F006E0074007D00200073006F006E007400200064006900730070006F006E00690062006C006500730020006400750020006E00690076006500610075002000360031002000E000200036003500200070006F00750072002000630068006100710075006500200063006C0061007300730065002E007B002F0041007D007B0041007D0045006E0020006F0075007400720065002C0020007B0066006F006E007400200063006F006C006F0072003D002200230046004600300030003000300022007D006C0065007300200063006F006D007000E900740065006E00630065007300200070007200E9006500780069007300740061006E0074006500730020006F006E0074002000E9007400E900200061006D00E9006C0069006F007200E900650073007B002F0066006F006E0074007D002C002000650074002000700065007500760065006E0074002000EA0074007200650020006100630071007500690073006500730020006100750070007200E800730020006400650020006C00270069006E0073007400720075006300740065007500720020006400650020006D00610067006900650020006F0075002000640065002000740061006300740069007100750065007300200063006F006D006D0065002000E00020006C0027006100630063006F007500740075006D00E90065002E007B002F0041007D003C00620072003E007B0034007D0041006D007500730065007A002D0076006F007500730020006200690065006E002000640061006E0073002000460061007400650020006F00660020004100720075006E00200021007B002F0034007D003C00620072003E007B0041007D0050006F0075007200200070006C007500730020006400192069006E0066006F0072006D006100740069006F006E0073002C0020006D006500720063006900200064006500200063006F006E00730075006C0074006500720020006C0065002000730069007400650020006F006600660069006300690065006C002000660072002E0074006500720061002E00670061006D00650066006F007200670065002E0063006F006D00200021007B002F0041007D000000"));
        
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("7EC40000000000000000"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("A361"));
        connection.sendPacket(new SM_OPCODE_LESS_PACKET("19ED00000000"));

        QuestService.getInstance().onPlayerEnterWorld(player);

        connection.sendPacket(new SM_INVENTORY(player, false));
    }
}
